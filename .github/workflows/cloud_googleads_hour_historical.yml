name: cloud_googleads_hour_historical

on:
  workflow_dispatch:  # Permite execu√ß√£o manual
  schedule:
    # Executa diariamente √†s 10:00 AM hor√°rio do Brasil (GMT-3) = 13:00 UTC
    # Durante hor√°rio de ver√£o (GMT-2) = 12:00 UTC, mas mantemos 13:00 UTC para consist√™ncia
    - cron: "0 13 * * *"

jobs:
  collect-google-ads-historical-data:
    runs-on: [self-hosted, linux, x64]
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      - name: üêç Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'  # Cache autom√°tico baseado em requirements.txt

      - name: üì¶ Instalar depend√™ncias
        working-directory: google_ads/cloud_googleads_hour_historical
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: üîç Verificar vers√µes instaladas
        run: |
          echo "=== Vers√µes das bibliotecas principais ==="
          python -c "
          import pkg_resources
          import grpc
          import google.api_core
          import google.cloud.bigquery
          try:
              ga_version = pkg_resources.get_distribution('google-ads').version
              print(f'‚úÖ google-ads: {ga_version}')
          except:
              print('‚ö†Ô∏è google-ads: vers√£o n√£o detectada')
          print(f'‚úÖ grpcio: {grpc.__version__}')
          print(f'‚úÖ google-api-core: {google.api_core.__version__}')
          print(f'‚úÖ google-cloud-bigquery: {google.cloud.bigquery.__version__}')
          "
          echo "=========================================="

      - name: üöÄ Executar coleta de dados hist√≥ricos (ontem)
        working-directory: google_ads/cloud_googleads_hour_historical
        env:
          SECRET_GOOGLE_SERVICE_ACCOUNT: ${{ secrets.SECRET_GOOGLE_SERVICE_ACCOUNT }}
          SECRET_GOOGLE_ADS_CONFIG: ${{ secrets.SECRET_GOOGLE_ADS_CONFIG }}
          # Vari√°veis de ambiente para otimizar GRPC
          GRPC_ENABLE_FORK_SUPPORT: "1"
          GRPC_POLL_STRATEGY: "poll"
          GRPC_PYTHON_LOG_LEVEL: "ERROR"
        run: |
          python main.py

      - name: ‚úÖ Resultado
        if: success()
        run: |
          echo "üéâ Dados hist√≥ricos (ontem) coletados e enviados ao BigQuery com sucesso!"
          
      - name: ‚ùå Tratamento de erro
        if: failure()
        run: |
          echo "‚ùå Falha na coleta de dados hist√≥ricos. Verifique os logs acima."
          exit 1


